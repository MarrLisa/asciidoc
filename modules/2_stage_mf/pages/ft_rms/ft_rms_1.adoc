// tag::rms_nnn_ft[]
// Описание требование в ЧТЗ
:figure-caption!:
:imagesdir: ../images
==== {ft} 

Интеграция данных о субсидиях и социальном заказе с Единым порталом государственных услуг (ЕПГУ). Обеспечить бесшовную передачу информации о субсидиях и социальном заказе из системы Минфина России на ЕПГУ посредством интеграции с ЕСНСИ. Это позволит создать Единое окно доступа к информации о мерах государственной поддержки для пользователей ЕПГУ.

[%breakable]
===== Расширение моделей данных и справочников

====== Модель данных отборов (mf-data.Selections):


Добавить поле ShortDescription (varchar(160)) для хранения краткого описания отбора. Значение по умолчанию: NULL.

Добавить поле Description (text) для хранения полного описания отбора. Значение по умолчанию: NULL.

====== Модель данных отборов социального заказа (mf-data.SoSelections): 


Добавить поле ShortDescription (varchar(160)) для хранения краткого описания отбора. Значение по умолчанию: NULL.

Добавить поле Description (text) для хранения полного описания отбора. Значение по умолчанию: NULL.

====== Модель данных версий субсидий (mf-data.ActivityVersions): 

:num_t: {counter:table-number}

Добавить поле FullTitle (text) для хранения полного наименования субсидии. Значение по умолчанию: NULL.

Добавить поле EnterpriseIsDisabled (boolean) для указания, оценивается ли размер предприятия. Значение по умолчанию для новых версий: false. Значение для существующих версий: true. При поднятии версии значение копируется из предыдущей версии.

Связь с размером бизнеса. Для хранения информации о размере бизнеса, связанном с версией субсидии, используется сущность mf-data.ActivityVersionEnterprise с атрибутивным составом указанным в <<id_t_{num_t}, Таблице {num_t}>>. 

// [.landscape]
// <<<<
[%breakable]
[#id_t_{num_t}]
.Таблица {num_t}. Атрибутный состав «mf-data.ActivityVersionEnterprise»
[cols= «1,5,4», options= «header»]
|===============================================================================
| № | Наименование атрибута                  | Системное имя                    
| {counter:t_row}. | Идентификатор записи                   | Id                               
| {counter:t_row}. | Идентификатор связи с версией субсидии | ActivityVersionId/GeneralEntityId
| {counter:t_row}. | Значение справочника                   | EnterpriseType                   
| {counter:t_row}. | Дата создания                          | CreatedDate                      
| {counter:t_row}. | Автор создания                         | CreatedBy                        
| {counter:t_row}. | Дата обновления                        | UpdatedDate                      
| {counter:t_row}. | Автор обновления                       | UpdatedBy                        
| {counter:t_row}. | Дата удаления                          | DeletedDate                      
| {counter:t_row}. | Автор удаления                         | DeletedBy                        
|===============================================================================
:!t_row:

Создать справочник размеров бизнеса со значениями: 
* «Крупный бизнес»; 
* «Средний бизнес»;. 
* «Малый бизнес»; .
* «Микробизнес».

====== Модель данных регулирующего документа отбора (mf-data.SelectionMainDocument) 

Создать сущность для хранения информации о регулирующем документе отбора.

Атрибутивный состав аналогичен сущностям SelectionAttachment и SelectionDocument.

====== Справочники ЕСНСИ

Доработать справочники в ЕСНСИ: MFIN_SUBSIDIES, MFIN_FUNDING, MFIN_REQUIREMENTS, MFIN_SOCIAL_ORDER.

Добавить атрибут Status (string) в справочники MFIN_SUBSIDIES и MFIN_SOCIAL_ORDER. Источник данных: mf-data.Competitions.Status.

[%breakable]
===== Формирование и отправка данных в ЕСНСИ

====== Формирование XML

Реализовать механизмы формирования XML-файлов для субсидий (3 файла: MFIN_SUBSIDIES, MFIN_FUNDING, MFIN_REQUIREMENTS) и социального заказа (1 файл: MFIN_SOCIAL_ORDER), как для всех опубликованных отборов, так и для отдельных отборов.

Обеспечить обработку множественных значений (разделитель  «~»), уникальность ОКВЭД и ОКТМО, заполнение всех необходимых атрибутов, включая корректную обработку полей, которые изначально были пустыми (Description, DescriptionShort, SubsidyDocText, SubsidyDocUrl, OrgInn, OrgOgrn, EnterpriseSizeCode, requirementsDocument1-32, SubjectType, Status). Учесть особенности заполнения атрибутов MaxAmountSize, MaxAmountDirectionName1-20 и MaxAmountDirectionSize1-20.

Ограничить длину атрибута Results в MFIN_SUBSIDIES до 5000 символов, обрезая по последнему целиком помещающемуся наименованию результата.

[%breakable]
====== Отправка данных в СМЭВ:

Реализовать автоматическую отправку данных через СМЭВ при публикации новой версии отбора.

Реализовать механизм очереди (mf-data.EsnsiQueue) для отправки данных, предотвращая дублирование записей с EntityId = CompetitionId, SyncDate = null и совпадающим Type, обрабатывая отборы каждые 15 минут. Реализовать скрипт для удаления записей с Type = 5, 6, 7, 8.

Реализовать endpoint для ручной отправки данных для всех субсидий.

Реализовать кнопку для ручной отправки данных для социального заказа в реестре логов СМЭВ (/smev-proxy/ на вкладке  «Настройка»). Добавить заголовок  «Отправка данных в справочники ЕСНСИ», подзаголовок  «Отборы Социальный заказ» и кнопку  «Отправить».

[%breakable]
===== Изменения пользовательского интерфейса 
====== Настройки субсидий 

:num_i: {counter:figure-number}
Изменить название поля  «Наименование субсидии» на  «Краткое наименование субсидии». Источник: ActivityVersions.Title. Компонент: InputTextarea с restrictInput = false. Валидировать поле при снятии фокуса, сохранении, проверке формы и отправке на согласование. Ограничение: 250 символов.

Добавить поле  «Полное наименование субсидии» (только для просмотра). Источник: ActivityVersions.FullTitle. Компонент: InputTextarea.

Добавить настройку  «Размер бизнеса» в секцию  «Основная информация» с чекбоксом  «Не оценивается» и мультиселектом для выбора размеров бизнеса. Подсказка:  «Выберите категории субъектов малого и среднего предпринимательства... (полный текст)». При включении чекбокса  «Не оценивается» очищать и блокировать мультиселект (<<id_i_{num_i}, см. Рисунок {num_i}>>). Сохранять значения в сущность mf-data.ActivityVersionEnterprise. 

Валидировать поле при отправке на согласование. 
. Обновить компонент оповещения. Использовать компонент Alert. Текст:  «Часть информации о субсидии... (полный текст)».
[%breakable]
[#id_i_{num_i}]
.Рисунок {num_i}. Включении чекбокса  «Не оценивается»
image::rms1_1.png[]

[%breakable]
====== Настройки отборов

:num_i: {counter:figure-number}
Добавить поля  «Краткое описание отбора» (обязательное, input-textarea, restrictInput = true, 48-160 символов, подсказка) и  «Полное описание отбора» (обязательное, editor, 2000 символов, подсказка) в секцию  «Основная информация» для субсидий и в секцию  «Общие настройки» для социального заказа (<<id_i_{num_i}, см. Рисунок {num_i}>>). Валидировать поля. Копировать значения при поднятии версии.

[%breakable]
[#id_i_{num_i}]
.Рисунок {num_i}. Поля описания отбора
image::rms1_2.png[]

:num_i: {counter:figure-number}
Добавить блок «Регулирующий документ» с полями «Название» (обязательное, 255 символов), «Описание» (необязательное, 4000 символов) и загрузкой файла (обязательная, максимум 1 файл, до 50 Мб, форматы pdf, doc, docx). Запретить удаление блока. Подсказка: «Укажите реквизиты одного основного документа...» (<<id_i_{num_i}, см. Рисунок {num_i}>>). Сохранять данные вmf-data.SelectionMainDocument. Валидировать поля при отправке на согласование. Копировать значения при поднятии версии. Не копировать блок при копировании отбора.

[%breakable]
[#id_i_{num_i}]
.Рисунок {num_i}. Блок «Регулирующий документ»
image::rms1_3.png[]

Вынести поле «Шифр отбора» наверх в секции «Общие настройки».

Заменить «название» на «наименование» в полях «Краткое наименование отбора» и «Полное наименование отбора».

Обновить компонент оповещения. Использовать компонент Alert. Текст: «Часть информации об отборе... (полный текст)».

Ограничить длину полного наименования отбора до 500 символов. Использовать компонент input-textarea с restrictInput = false. Валидировать поле при вводе, потере фокуса, сохранении и отправке на согласование.

[%breakable]
====== Ссылки

Исправить ссылки на отборы: «$»/public/minfin/selection/view/{competition.Id}?competitionType={(int)competition.Type}» заменить на /public/minfin/selection/view/{competition.Id}?competitionType={competition.Type}&utm_source=epgu. Добавить параметр showBackButton=true для ссылок на отборы СЗ.

Исправить ссылки на субсидии: «$»/public/minfin/activity/view/{activityId}» заменить на /public/minfin/activity/view/{activityId}/esia-auth?utm_source=epgu.

Обеспечить корректную работу ссылок с авторизацией ЕСИА (перенаправление на страницу авторизации для неавторизованных пользователей, открытие страницы после авторизации).

[%breakable]
====== Кнопка ручной отправки данных СЗ 

:num_i: {counter:figure-number}
В реестре логов СМЭВ (/smev-proxy/ на вкладке «Настройка») под кнопкой «Сохранить» добавить заголовок: «Отправка данных в справочники ЕСНСИ» и подзаголовок: «Отборы Социальный заказ» (<<id_i_{num_i}, см. Рисунок {num_i}>>).

[%breakable]
[#id_i_{num_i}]
.Рисунок {num_i}. Кнопка: «Отправить»
image::rms1_4.png[]

[%breakable]
===== Обновление PDF и XML документов
====== Профиль субсидии

:num_i: {counter:figure-number}
Добавить поле «Полное наименование субсидии» (источник: mf-data.ActivityVersions.FullTitle). Не выводить поле, если значение пустое (<<id_i_{num_i}, см. Рисунок {num_i}>>).

[%breakable]
[#id_i_{num_i}]
.Рисунок {num_i}. Поле «Полное наименование субсидии»
image::rms1_5.png[]

Добавить информацию о размере бизнеса (источники: mf-data.ActivityVersions.EnterpriseIsDisabled, mf-data.ActivityVersionEnterprise).

[%breakable]
====== Объявление об отборе «Субсидийный»:

:num_i: {counter:figure-number}
Переименовать поле «Наименование отбора» в «Полное наименование отбора». Добавить поле «Краткое наименование отбора» (источник: mf-data.Selections.SelectionShortName). Добавить поля «Краткое описание отбора» (источник: mf-data.Selections.ShortDescription) и «Полное описание отбора» (источник: mf-data.Selections.Description) (<<id_i_{num_i}, см. Рисунок {num_i}>>).

[%breakable]
[#id_i_{num_i}]
.Рисунок {num_i}. Поле наименования отбора
image::rms1_6.png[]

:num_i: {counter:figure-number}
Добавить блок «Регулирующий документ» (<<id_i_{num_i}, см. Рисунок {num_i}>>), (наименование: mf-data.SelectionMainDocument.Title, описание: mf-data.SelectionMainDocument.Description, гиперссылка на скачивание).

[%breakable]
[#id_i_{num_i}]
.Рисунок {num_i}. Блок «Регулирующий документ»
image::rms1_7.png[]

[%breakable]
====== Объявление об отборе «Социальный заказ»:

Добавить поля «Краткое описание отбора» (источник: mf-data.SoSelections.ShortDescription) и «Полное описание отбора» (источник: mf-data.SoSelections.Description).

// end::rms_nnn_ft[]

// tag::rms_nnn_ot[]
// Описание требование в ОПЗ

// Цели, критерии и ограничения функциональной подсистемы (компонента, модуля) системы "Электронный бюджет"

Цель: расширение передаваемых данных на ЕПГУ, расчёт дополнительных данных, внесение изменений в настройки отбора и субсидий.

Критерии:

* корректность передачи данных о субсидиях и социальном заказе из системы Минфина России на ЕПГУ через ЕСНСИ;
* соответствие данных в ЕСНСИ информации на портале Минфина России.

Ограничения:

* интеграция должна осуществляться через ЕСНСИ, с использованием справочников MFIN_SUBSIDIES, MFIN_FUNDING, MFIN_REQUIREMENTS, MFIN_SOCIAL_ORDER;
* длина наименования результата в справочнике MFIN_SUBSIDIES ограничена 5000 символов.

// Требования к функциям Модуля, включая требования к бизнес-процессам, реализуемым Модулем системы "Электронный бюджет"

===== Реализуемые бизнес-процессы

Формирование XML для ЕСНСИ. Система должна формировать XML-файлы для справочников ЕСНСИ в соответствии с атрибутивным составом [ссылка на атрибутивный состав в приложении]. Для субсидий должны формироваться три отдельных файла (MFIN_SUBSIDIES, MFIN_FUNDING, MFIN_REQUIREMENTS), для социального заказа - один файл (MFIN_SOCIAL_ORDER). Должна быть реализована возможность формирования XML как для всех опубликованных отборов, так и для отдельных отборов.

Отправка данных в СМЭВ. Система должна отправлять сформированные XML-файлы в СМЭВ для обновления справочников ЕСНСИ. Отправка должна осуществляться автоматически при публикации новой версии отбора. Также должна быть предусмотрена возможность ручной отправки данных.

Обработка очереди отправки. Система должна обрабатывать очередь отправки данных в ЕСНСИ (mf-data.EsnsiQueue), предотвращая дублирование отборов в очереди и отправляя данные каждые 15 минут.

Обновление данных на ЕПГУ. При публикации новой версии отбора или изменении его статуса система должна автоматически добавлять отбор в очередь отправки данных в ЕСНСИ. После отправки данных справочники ЕСНСИ обновляются, и информация на ЕПГУ становится актуальной.

===== Бизнес-процесс "Публикация новой версии отбора":

Цель: обновить информацию об отборе в ЕСНСИ и на ЕПГУ.

Входные данные: данные новой версии отбора, включая:

. Краткое наименование отбора (mf-data.Selections.SelectionShortName / mf-data.SoSelections.Name).
. Полное наименование отбора (mf-data.Selections.SelectionName / mf-data.SoSelections.Name).
. Краткое описание отбора (mf-data.Selections.ShortDescription / mf-data.SoSelections.ShortDescription).
. Полное описание отбора (mf-data.Selections.Description / mf-data.SoSelections.Description).
. Регулирующий документ (данные из mf-data.SelectionMainDocument).
. Размер бизнеса (mf-data.ActivityVersions.EnterpriseIsDisabled, mf-data.ActivityVersionEnterprise).
. Даты начала и окончания приема заявок (mf-data.Selections.StartDate, mf-data.Selections.EndDate).
. ... (другие необходимые атрибуты из XML для ЕСНСИ).

Выходные данные:

. XML-файлы для справочников ЕСНСИ (MFIN_SUBSIDIES, MFIN_FUNDING, MFIN_REQUIREMENTS, MFIN_SOCIAL_ORDER).
. Запись в очереди отправки данных в ЕСНСИ (mf-data.EsnsiQueue).
. Участники процесса: Пользователь системы, сервис формирования XML, сервис отправки данных в СМЭВ.

Рисунок БП ЗАБРАТЬ В ГЛАВЕ БП


:num_i: {counter:figure-number}
Процесс обновления информации об отборе в ЕСНСИ и на ЕПГУ представлен на <<id_i_{num_i}, Рисунке {num_i}>>.

[%breakable]
[#id_i_{num_i}]
.Рисунок {num_i}. Обновление информации об отборе в ЕСНСИ и на ЕПГУ
image::Обновление_информации_ЕСНСИ.png[]

:num_t: {counter:table-number}
Последовательность действий представлен в <<id_t_{num_t}, Таблице {num_t}>>. 

[%breakable]
[#id_t_{num_t}]
.Таблица {num_t}. Перечень и описание компонентов Модуля
[cols="1,2,4,3,3,3", options="header"]
|===
^| № ^| Действие                                                   ^| Описание действия                                                                                ^| Исполнитель                                    ^| Входные данные                                             ^| Результат (выходные данные)                                                             
| 1 | Сохранение версии отбора                                   | Пользователь сохраняет новую или измененную версию отбора.                                       | Пользователь системы                           | Данные версии отбора (наименование, описание, даты и т.д.) | Сохраненная версия отбора в БД                                                          
| 2 | Проверка статуса отбора                                    | Система проверяет статус сохраненной версии отбора.                                              | Система                                        | ID версии отбора                                           | Статус версии отбора (опубликована или нет)                                             
| 3 | Запуск формирования XML (только для опубликованных версий) | Если версия отбора опубликована (статус = 5), система запускает сервис формирования XML.         | Система                                        | Статус версии отбора                                       | Вызов функции формирования XML                                                          
| 4 | Формирование XML                                           | Сервис формирует XML-файлы для справочников ЕСНСИ на основе данных опубликованной версии отбора. | Система (компонент m-data формирует XML-файлы) | Данные версии отбора                                       | XML-файлы для ЕСНСИ (MFIN_SUBSIDIES, MFIN_FUNDING, MFIN_REQUIREMENTS, MFIN_SOCIAL_ORDER)
| 5 | Добавление в очередь отправки                              | Система добавляет запись в очередь mf-data.EsnsiQueue для последующей отправки данных в СМЭВ.    | Система                                        | XML-файлы, ID отбора, тип справочника                      | Запись в очереди mf-data.EsnsiQueue                                                     
| 6 | Отправка данных в СМЭВ                                     | Сервис отправки данных периодически проверяет очередь и отправляет данные в ЕСНСИ через СМЭВ.    | Сервис отправки данных в СМЭВ                  | Данные из очереди mf-data.EsnsiQueue (XML-файлы)           | Подтверждение отправки данных в СМЭВ, обновление SyncDate в mf-data.EsnsiQueue          
|===


===== Бизнес-процесс "Ручная отправка данных в ЕСНСИ:

Цель: Обновить данные в ЕСНСИ по требованию пользователя.

Входные данные: Тип отбора (субсидии или социальный заказ), идентификатор отбора (необязательно).

Выходные данные: XML-файлы для ЕСНСИ, отправленные в СМЭВ.

Участники процесса: Пользователь системы, сервис формирования XML, сервис отправки данных в СМЭВ.

:num_i: {counter:figure-number}
Процесс ручной отправки данных представлен на <<id_i_{num_i}, Рисунке {num_i}>>.

[%breakable]
[#id_i_{num_i}]
.Рисунок {num_i}. Ручная отправка данных
image::Ручная_отправка_ЕСНСИ.png[]

:num_t: {counter:table-number}
Последовательность действий представлен в <<id_t_{num_t}, Таблице {num_t}>>. 

[%breakable]
[#id_t_{num_t}]
.Таблица {num_t}. Перечень и описание компонентов Модуля
[cols="1,2,4,3,3,3", options="header"]
|===
^| № ^| Действие              ^| Описание действия                                                                                     ^| Исполнитель                                    ^| Входные данные                                             ^| Результат (выходные данные)                                                             
      
| 1 | Запрос на отправку данных | Пользователь нажимает кнопку "Отправить" или вызывает endpoint.                                         | Пользователь системы                                          | Тип отбора (субсидии/СЗ), ID отбора (опционально) | Запрос на формирование и отправку XML
| 2 | Запуск формирования XML   | Система запускает сервис формирования XML.                                                              | Система                                                       | Тип отбора, ID отбора (опционально)               | Запуск сервиса формирования XML      
| 3 | Формирование XML          | Система формирует XML-файлы для всех опубликованных отборов указанного типа или для конкретного отбора. | Система вызывает функцию формирования XML в компоненте m-data | Тип отбора, ID отбора (опционально)               | XML-файлы для ЕСНСИ                  
| 4 | Отправка данных в СМЭВ    | Система отправляет сформированные XML-файлы в СМЭВ.                                                     | Сервис отправки данных в СМЭВ                                 | XML-файлы                                         | Подтверждение отправки данных в СМЭВ 
|===

===== Описание формуляров и информационных ресурсов

В данном разделе описываются только изменения, внесенные в формуляры и информационные ресурсы в рамках работ по адаптации 2 этап. Изменения включают добавление новых полей, изменение существующих полей и создание новых информационных ресурсов.

[.landscape]
<<<<

Изменения в формулярах:
[cols="3,3,2,3,3,2,4,5", options="header"]
|===
^| Формуляр                         ^| Поле/Блок                     ^| Действие  ^| Тип данных                  ^| Обязательность              ^| Ограничения                                                                      ^| Источник данных                                                                  ^| Комментарий                                                                                                                                                        
| Настройки субсидии               | Краткое наименование субсидии | Изменено  | Text (InputTextarea)        | Да                          | 250 символов                                                                     | mf-data.ActivityVersions.Title                                                   | restrictInput = false. Валидация при потере фокуса, сохранении, проверке формы и отправке на согласование.                                                         
| Настройки субсидии               | Полное наименование субсидии  | Добавлено | Text (InputTextarea)        | Нет                         | -                                                                                | mf-data.ActivityVersions.FullTitle                                               | Только для просмотра.                                                                                                                                              
| Настройки субсидии               | Размер бизнеса                | Добавлено | Чекбокс + Мультиселект      | Да (если чекбокс неактивен) | -                                                                                | mf-data.ActivityVersions.EnterpriseIsDisabled, mf-data.ActivityVersionEnterprise | Чекбокс "Не оценивается". Если чекбокс активен, мультиселект недоступен. Значения мультиселекта: "Крупный бизнес", "Средний бизнес", "Малый бизнес", "Микробизнес".
| Настройки субсидии               | Оповещение                    | Изменено  | Alert                       | -                           | -                                                                                | -                                                                                | Текст оповещения: "Часть информации о субсидии... (полный текст)"                                                                                                  
| Настройки отбора (субсидии и СЗ) | Полное наименование отбора    | Изменено  | Text (input-textarea)       | Да                          | 500 символов                                                                     | mf-data.Selections.SelectionName / mf-data.SoSelections.Name                     | restrictInput = false. Валидация при вводе, потере фокуса, сохранении и отправке на согласование.                                                                  
| Настройки отбора (субсидии)      | Краткое описание отбора       | Добавлено | Text (input-textarea)       | Да                          | 48-160 символов                                                                  | mf-data.Selections.ShortDescription                                              | restrictInput = true. Валидация при сохранении.                                                                                                                    
| Настройки отбора (субсидии)      | Полное описание отбора        | Добавлено | Визивиг-редактор (editor)   | Да                          | 2000 символов                                                                    | mf-data.Selections.Description                                                   | Валидация при отправке на согласование.                                                                                                                            
| Настройки отбора (СЗ)            | Краткое описание отбора       | Добавлено | Text (input-textarea)       | Да                          | 48-160 символов                                                                  | mf-data.SoSelections.ShortDescription                                            | restrictInput = true. Валидация при сохранении.                                                                                                                    
| Настройки отбора (СЗ)            | Полное описание отбора        | Добавлено | Визивиг-редактор (editor)   | Да                          | 2000 символов                                                                    | mf-data.SoSelections.Description                                                 | Валидация при отправке на согласование.                                                                                                                            
| Настройки отбора (субсидии)      | Регулирующий документ         | Добавлено | Блок полей + загрузка файла | Да                          | Название: 255 символов. Описание: 4000 символов. Файл: до 50 Мб, pdf, doc, docx. | mf-data.SelectionMainDocument                                                    | Поля: "Название" (обязательное), "Описание" (необязательное), "Файл" (обязательный). Запретить удаление блока.                                                     
| Настройки отбора (субсидии и СЗ) | Оповещение                    | Изменено  | Alert                       | -                           | -                                                                                | -                                                                                | Текст оповещения: "Часть информация об отборе... (полный текст)"                                                                                                   
| Реестр логов СМЭВ                | Кнопка "Отправить" (для СЗ)   | Добавлено | Кнопка                      | -                           | -                                                                                | -                                                                                | Запускает ручную отправку данных для социального заказа.                                                                                                           
|===

[.portrait]
<<<<
    
:num_t: {counter:table-number}
Изменения в информационных ресурсах представлены в <<id_t_{num_t}, Таблице {num_t}>>. 

[%breakable]
[#id_t_{num_t}]
.Таблица {num_t}. Изменения в информационных ресурсах
[cols="3,2,5", options="header"]
|=======================================================================================================================================================================
^| Ресурс                            ^| Изменение         ^| Описание                                                                                                      
^| mf-data.Selections                | Добавлены поля    | ShortDescription (varchar(160)), Description (text)                                                           
^| mf-data.SoSelections              | Добавлены поля    | ShortDescription (varchar(160)), Description (text)                                                           
^| mf-data.ActivityVersions          | Добавлены поля    | FullTitle (text), EnterpriseIsDisabled (boolean)                                                              
^| mf-data.ActivityVersionEnterprise | Создана сущность  | Связь версии субсидии с размером бизнеса. Атрибуты: Id, ActivityVersionId, EnterpriseType, системные атрибуты.
^| mf-data.SelectionMainDocument     | Создана сущность  | Хранение данных о регулирующем документе отбора.                                                              
^| Справочник "Размеры бизнеса"      | Создан справочник | Значения: "Крупный бизнес", "Средний бизнес", "Малый бизнес", "Микробизнес".                                  
|=======================================================================================================================================================================


// end::rms_nnn_ot[]

// tag::rms_nnn_pz[]
// Описание требование в ПЗ

Перечень ролей технологического процесса:

:num_i: {counter:figure-number}
Схема бизнес-процесса представлена на <<id_i_{num_i}, Рисунке {num_i}>>.

[%breakable]
[#id_i_{num_i}]
.Рисунок {num_i}. Схема бизнес-процесса 
image::Ручная_отправка_ЕСНСИ.png[]


[cols="1,3,5", options="header"]
|==========================================================================================================================
^| № ^| Наименование роли    ^| Описание роли                                                                                 
^| {counter:t_row}. | Пользователь системы | Сотрудник Минфина, ответственный за создание и публикацию отборов.                            
^| {counter:t_row}. | Система              | Автоматизированная система, выполняющая обработку данных и взаимодействие с другими системами.
^| {counter:t_row}. | Компонент m-data     | Компонент системы, отвечающий за хранение данных об отборах и формирование XML для ЕСНСИ.     
^| {counter:t_row}. | Компонент smev-proxy | Компонент системы, отвечающий за взаимодействие с СМЭВ и отправку данных в ЕСНСИ.             
|==========================================================================================================================
:!t_row:

[cols="1,5,3", options="header"]
|====================================================================================================================
| {counter:t_row}. | Начало процесса сохранения и отправки данных                      | Начальное событие           |             
| {counter:t_row}. | Сохранение версии отбора                                          | Действие пользователя       | Пользователь
| {counter:t_row}. | Проверка статуса отбора                                           | Автоматизированное действие | Система     
| {counter:t_row}. | Проверка: версия отбора опубликована (статус = 5)?                | Исключающий шлюз            | Система     
| {counter:t_row}. | Запуск формирования XML (если статус = 5)                         | Автоматизированное действие | Система     
| {counter:t_row}. | Формирование XML                                                  | Автоматизированное действие | Система     
| {counter:t_row}. | Версия отбора в ином статусе (если статус != 5)                   | Конечное событие            |             
| {counter:t_row}. | Добавление в очередь отправки (smev-proxy)                        | Автоматизированное действие | Система     
| {counter:t_row}. | Вывод сообщения об ошибке (при ошибке формирования XML)           | Исключающий шлюз            | Система     
| {counter:t_row}. | Вывод сообщения об ошибке                                         | Автоматизированное действие | Система     
| {counter:t_row}. | Асинхронная отправка через очередь (после добавления в очередь)   | Исключающий шлюз            | Система     
| {counter:t_row}. | Отправка данных в СМЭВ (после проверки очереди - каждые 15 минут) | Автоматизированное действие | Система     
| {counter:t_row}. | Данные отправлены в ЕСНСИ                                         | Конечное событие            |             
| {counter:t_row}. | Вывод сообщения об ошибке (при ошибке отправки в СМЭВ)            | Исключающий шлюз            | Система     
| {counter:t_row}. | Вывод сообщения об ошибке                                         | Автоматизированное действие | Система     
| {counter:t_row}. | Конец процесса (после успешной отправки)                          | Конечное событие            |             
|====================================================================================================================
:!t_row:

[cols="1,5,3,2", options="header"]
|=====================================================================================================================================
| №  | Описание подпроцесса/события/условия                                               | Тип действия                | Участник    
| {counter:t_row}. | Начало процесса отправки данных                                                    | Начальное событие           |             
| {counter:t_row}. | Запрос на отправку                                                                 | Действие пользователя       | Пользователь
| {counter:t_row}. | Указан Id отбора?                                                                  | Исключающий шлюз            | Система     
| {counter:t_row}. | Запуск формирования XML по вх. д. Тип отбора, ID отбора (если Id указан)           | Автоматизированное действие | Система     
| {counter:t_row}. | Формирование XML (если Id указан)                                                  | Автоматизированное действие | Система     
| {counter:t_row}. | Запуск формирования XML по вх. д. Тип отбора (если Id не указан)                   | Автоматизированное действие | Система     
| {counter:t_row}. | Формирование XML (если Id не указан)                                               | Автоматизированное действие | Система     
| {counter:t_row}. | Добавление в очередь отправки (smev-proxy)                                         | Автоматизированное действие | Система     
| {counter:t_row}. | Асинхронная отправка через очередь                                                 | Исключающий шлюз            | Система     
| {counter:t_row}. | Отправка данных в СМЭВ (после проверки очереди - каждые 15 минут)                  | Автоматизированное действие | Система     
| {counter:t_row}. | Данные данных для конкретного отбора отправлены в ЕСНСИ (если Id указан)           | Конечное событие            |             
| {counter:t_row}. | Данные данных для всех отборов данного типа отправлены в ЕСНСИ (если Id не указан) | Конечное событие            |             
|=====================================================================================================================================

:!t_row:

// end::rms_nnn_pz[]

// tag::rms_nnn_oaf[]
// Описание требование в ОАФ

Модуль реализует следующие функции, связанные с публикацией информации о субсидиях и социальном заказе на ЕПГУ:

* Формирование XML-файлов для передачи данных о субсидиях и социальном заказе в справочники ЕСНСИ (MFIN_SUBSIDIES, MFIN_FUNDING, MFIN_REQUIREMENTS, MFIN_SOCIAL_ORDER);
* Отправка сформированных XML-файлов в СМЭВ для обновления справочников ЕСНСИ;
* Управление очередью отправки данных в ЕСНСИ (mf-data.EsnsiQueue).

Данные функции взаимодействуют с компонентами m-data и smev-proxy.

// === Описание процесса выполнения функций, реализуемых модулем, и их декомпозицию до операций, выполняемых автоматически и (или) вручную

===== Формирование XML для ЕСНСИ:

Автоматически:

* Получение данных о субсидиях и отборах из БД mf-data.
* Обработка данных согласно правилам, описанным в ЧТЗ (обработка множественных значений, уникальность ОКВЭД и ОКТМО, заполнение обязательных полей, ограничение длины полей).
* Формирование XML-файлов в соответствии с атрибутивным составом справочников ЕСНСИ.
* Валидация сформированных XML-файлов.

===== Отправка данных в СМЭВ:

Автоматически:

* Получение данных из очереди отправки mf-data.EsnsiQueue;
* Отправка XML-файлов в СМЭВ;
* Обработка ответа от СМЭВ;
* Обновление статуса отправки в очереди mf-data.EsnsiQueue.

Вручную (по запросу пользователя):

* Запуск формирования XML для всех опубликованных отборов или для конкретного отбора;
* Отправка сформированных XML-файлов в СМЭВ.

===== Обработка очереди отправки:

Автоматически:

* Добавление новых записей в очередь при публикации новой версии отбора.
* Периодическая проверка очереди (каждые 15 минут).
* Отправка данных из очереди в СМЭВ.
* Удаление обработанных записей из очереди.

===== Сведения об информационном взаимодействии с внешними информационными системами

Модуль взаимодействует со следующими внешними системами:

[cols="3,8", options="header"]
|===========================================================================================================================================================================================================
^| Система                 ^| Информационное взаимодействие                                                                                                                                                   
| ЭБ (Электронный бюджет) | Получение данных о субсидиях. Способ обмена: API. Протоколы: SendSubsidyRequest, SendOperatorSubsidyRequest, SendSubsidyNonFederalRequest, SendOperatorSubsidyNonFederalRequest.
| ЕСНСИ                   | Отправка данных о субсидиях и социальном заказе. Способ обмена: СМЭВ. Формат данных: XML.                                                                                       
| ЕПГУ                    | Опосредованное взаимодействие через ЕСНСИ. Данные, отправленные в ЕСНСИ, отображаются на ЕПГУ.                                                                                  
|===========================================================================================================================================================================================================

// end::rms_nnn_oaf[]